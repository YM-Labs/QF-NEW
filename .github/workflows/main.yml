name: Azure Blob Storage Backup

on:
  push:
    branches: main

jobs:
  backup:
    runs-on: windows-latest

    steps:

      - name: Backup Azure Blob Storage
        uses: azure/powershell@v1
        with:
          inlineScript: |
             $resourceGroupName = "QF-SWA"
             $storageAccountName = "qfstw"
             Connect-AzAccount
             Select-AzSubscription -SubscriptionId "c3dff2a8-ba98-4189-94a7-d3a42bfc42cd"
             $connectionString = Get-AzStorageAccountKey -ResourceGroupName $resourceGroupName -Name $storageAccountName | Select-Object -ExpandProperty PrimaryConnectionString

             $web = '$web'
             $sourceContext = New-AzStorageContext -ConnectionString $connectionString
             $sourceBlobList = Get-AzStorageBlob -Container $web -Context $sourceContext

             $destinationContainerName = "backup-" + (Get-Date).ToString("yyyyMMddHHmmss")
             New-AzStorageContainer -Name $destinationContainerName -Context $sourceContext
             $destinationContext = New-AzStorageContext -ConnectionString $connectionString
             foreach ($blob in $sourceBlobList) {
                $destinationBlobName = $blob.Name
                $destinationBlob = Start-AzStorageBlobCopy -Context $destinationContext -SrcContainer $web -SrcBlob $blob.Name -DestContainer $destinationContainerName -DestBlob $destinationBlobName -Force
              }
              azPSVersion: "latest"
