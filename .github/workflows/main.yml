name: Azure Blob Storage Backup

on:
  push:
    branches: main

jobs:
  backup:
    runs-on: windows-latest

    steps:

      - name: Backup Azure Blob Storage
        uses: azure/powershell@v1
        with:
          inlineScript: |
            $web = '$web'
            $storageAccount = Get-AzStorageAccount -ResourceGroupName QF-SWA -Name qfstw
            $storageAccountKey = (Get-AzStorageAccountKey -ResourceGroupName $storageAccount.ResourceGroupName -Name $storageAccount.StorageAccountName)[0].Value
            $sourceContext = New-AzStorageContext -StorageAccountName $storageAccount.StorageAccountName -StorageAccountKey $storageAccountKey
            $sourceBlobList = Get-AzStorageBlob -Container $web -Context $sourceContext
            $destinationContainerName = "backup-" + (Get-Date).ToString("yyyyMMddHHmmss")
            New-AzStorageContainer -Name $destinationContainerName -Context $sourceContext
            $destinationContext = New-AzStorageContext -ConnectionString $connectionString
            foreach ($blob in $sourceBlobList) {
                $destinationBlobName = $blob.Name
                $destinationBlob = Start-AzStorageBlobCopy -Context $destinationContext -SrcContainer $web -SrcBlob $blob.Name -DestContainer $destinationContainerName -DestBlob $destinationBlobName -Force
            }
          azPSVersion: "latest"
